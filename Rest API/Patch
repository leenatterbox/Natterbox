enable_debug("email")

local timeNow = os.time()
local sftimeNow = strftime('%Y-%m-%d %H:%M:%S', timeNow, 'Europe/London')
print(sftimeNow)

local dateTime = sftimeNow
local callerNumber = session.get("E164CallerNumber")
local calledNumber = session.get("E164CalledNumber")
local uuid = session.get("UUID")
local agentName = session.get("OwnerFirstName").." "..session.get("OwnerLastName")
local reason = session.get("HangupCause")
local direction = session.get("CallDirection")

local body = {}
body.data = {}
body.data.id = uuid
body.data.from = callerNumber
body.data.to = calledNumber
body.data.type = direction
body.data.agentName = agentName
body.data.date = dateTime
body.data.finishReason = reason

local bodyJson = json_encode(body)

local url = 'https://my-api-url.com'

local headers = {}
headers.accept = 'application/json'
headers['accept'] = 'application/json'
headers['API-KEY'] = 'xxxxxx'
        
local res = rest.patch(url, headers, {}, bodyJson, 'application/json')
if res.result == 'OK' then
    print("Response Code: "..(res.code or ''))
    print("Response Message: "..(res.message or ''))
    print("Response ContentType: "..(res.contentType or ''))
else
    print("Rest call failed to return with error: "..res.result)
end
